# Audit: Maturity Gaps — Features, Error Handling, Documentation

**Date**: 2026-02-26
**Scope**: VM natives, error reporting, documentation coverage
**Baseline**: 929 workspace tests passing, branch `fix/remove-silent-int-field-promotion`

---

## Summary

Assessment of maturity gaps identified through codebase analysis. Focuses on missing VM-level features that exist only in the circuit pipeline, incomplete error diagnostics, and documentation staleness.

---

## Findings

| ID | Severity | Description | Status |
|----|----------|-------------|--------|
| F-01 | High | `poseidon()` / `poseidon_many()` not available as VM natives — only usable in circuit mode | Resolved |
| F-02 | Medium | `verify_proof()` not implemented — proofs can be generated but not verified at runtime | Resolved |
| F-03 | Medium | VM runtime errors lack source location — no line numbers in error messages | Resolved |
| F-04 | Low | 8 string natives (`substring`, `indexOf`, `split`, `trim`, `replace`, `toUpper`, `toLower`, `chars`) undocumented in README | Resolved |
| F-05 | Low | `--solidity` CLI flag not documented in README | Resolved |
| D-10 | — | Plonkish O(N²) lookup | Already fixed (uses `HashSet` since earlier audit) |
| — | — | REPL not implemented | Deferred (out of scope) |

---

## Detailed Analysis

### F-01: `poseidon()` / `poseidon_many()` VM Natives (High)

**Issue**: The Poseidon hash function exists in the `constraints` crate (`poseidon_hash`, `poseidon_hash_single`) and is available in circuit mode, but cannot be called from regular VM execution. Users writing general-purpose Achronyme programs that need Poseidon hashing (e.g., computing Merkle roots, hashing data) must use `prove {}` blocks even when they don't need a proof.

**Impact**: Forces circuit overhead for pure-computation use cases. Breaks the "dual execution" story — the language should support both modes seamlessly.

**Fix**: Add `constraints` as a dependency of `vm`, implement `native_poseidon(a, b)` and `native_poseidon_many(a, b, ...)` in `vm/src/stdlib/core.rs`, register at indices 20-21 in `specs.rs`.

---

### F-02: `verify_proof()` VM Native (Medium)

**Issue**: The `prove {}` block generates `ProofObject` values (accessible via `proof_json`, `proof_public`, `proof_vkey` natives), but there is no way to verify a proof at runtime. The Groth16 verification is only done internally as a sanity check during proof generation.

**Impact**: Proofs are opaque — users can generate them and extract JSON, but cannot programmatically verify one proof against another or validate external proofs.

**Fix**: Add `VerifyHandler` trait (mirrors `ProveHandler` pattern), implement `native_verify_proof(proof)` that delegates to the handler, implement handler in CLI using `ark-groth16::Groth16::verify`.

---

### F-03: VM Runtime Errors Lack Source Location (Medium)

**Issue**: When a runtime error occurs (e.g., `IntegerOverflow`, `DivisionByZero`, `TypeMismatch`), the error message contains no line number or function name. Users see errors like `Runtime Error: IntegerOverflow` with no indication of where the error occurred in their source code.

**Impact**: Debugging is significantly harder, especially in larger programs. Users must add print statements or binary-search to find the offending line.

**Fix**: Add `line_info: Vec<u32>` to `FunctionCompiler` (one entry per bytecode instruction), propagate to `Function` struct. In `VM::interpret()`, set `last_error_location` before returning errors. Format with line info at the CLI error display site.

---

### F-04: String Natives Undocumented (Low)

**Issue**: 8 string utility functions were added (`substring`, `indexOf`, `split`, `trim`, `replace`, `toUpper`, `toLower`, `chars`) but not listed in the README's native functions table.

**Fix**: Update README.md native functions table.

---

### F-05: `--solidity` Flag Undocumented (Low)

**Issue**: The `circuit` command supports `--solidity` for Solidity verifier generation, but this flag is not documented in the README.

**Fix**: Add `--solidity` to README CLI reference.

---

## Verification

After all fixes:
```sh
cargo fmt --all -- --check && cargo clippy --workspace -- -D warnings && cargo test --workspace
```
