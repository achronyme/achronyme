# Achronyme VM Bytecode Compiler — Bug Report

**Date**: 2026-02-22
**Scope**: Bytecode compiler (`compiler/`) and VM runtime (`vm/`)
**Method**: Black-box testing via `.ach` test suite (`test/*.ach`)
**Status**: Resolved — all 7 findings fixed

---

## Summary

| Severity | Count | Status |
|----------|-------|--------|
| HIGH     | 3     | All fixed |
| MEDIUM   | 3     | All fixed |
| LOW      | 1     | Fixed |
| **Total** | **7** | **All resolved** |

---

## Findings

### B-01 — `^` power operator not functional in bytecode path

| Field | Value |
|-------|-------|
| **Severity** | HIGH |
| **Crate** | `compiler` |
| **File** | `compiler/src/expressions/postfix.rs:20` |
| **Reproducer** | `assert(2 ^ 10 == 1024)` |
| **Status** | **FIXED** |

**Root cause**: `compile_prefix()` passed `pow_expr` to `compile_postfix()` which didn't handle `pow_op`.

**Fix**: Changed `self.compile_postfix(expr_pair)` to `self.compile_expr(expr_pair)` at line 20, correctly routing `pow_expr` through `compile_binary`.

---

### B-02 — `fn_decl` statement not handled by bytecode compiler

| Field | Value |
|-------|-------|
| **Severity** | HIGH |
| **Crate** | `compiler` |
| **File** | `compiler/src/statements/mod.rs:17-68` |
| **Reproducer** | `fn add(a, b) { return a + b }` |
| **Status** | **FIXED** |

**Root cause**: `compile_stmt` had no arm for `Rule::fn_decl`.

**Fix**: Added `Rule::fn_decl` match arm that delegates to `compile_fn_expr` and frees the result register.

---

### B-03 — `for..in` loop register double-free panic

| Field | Value |
|-------|-------|
| **Severity** | HIGH |
| **Crate** | `compiler` |
| **File** | `compiler/src/control_flow.rs:201-248` |
| **Reproducer** | `for item in [1, 2, 3] { print(item) }` |
| **Status** | **FIXED** |

**Root cause**: `val_reg` freed twice — once by `end_scope()`, once explicitly.

**Fix**: Removed the explicit `free_reg(val_reg)`. `end_scope()` handles it via `scopes.rs:38`.

---

### B-04 — `else if` chains cause register hygiene panic

| Field | Value |
|-------|-------|
| **Severity** | MEDIUM |
| **Crate** | `compiler` |
| **File** | `compiler/src/control_flow.rs` (compile_if) |
| **Reproducer** | `if false { 1 } else if true { 2 } else { 3 }` |
| **Status** | **FIXED** |

**Root cause**: Recursive `if_expr` in else branch caused register count mismatch.

**Fix**: `compile_if` now allocates a `target_reg` for the entire expression, moves recursive results into it, and frees intermediate registers correctly.

---

### B-05 — String concatenation with `+` not supported

| Field | Value |
|-------|-------|
| **Severity** | MEDIUM |
| **Crate** | `vm` |
| **File** | `vm/src/machine/arithmetic.rs:53-57` |
| **Reproducer** | `"hello" + " world"` |
| **Status** | **FIXED** |

**Root cause**: `Add` opcode only dispatched on numeric types.

**Fix**: Added string check before numeric dispatch — if either operand `is_string()`, both are converted via `val_to_string()` and concatenated.

---

### B-06 — Identifier names starting with keywords are misparsed

| Field | Value |
|-------|-------|
| **Severity** | MEDIUM |
| **Crate** | `achronyme-parser` |
| **File** | `achronyme-parser/src/grammar.pest` (stmt rule) |
| **Reproducer** | `mut letter = "F"; letter = "B"; print(letter)` |
| **Status** | **FIXED** |

**Root cause**: PEG ordered choice tried `let_decl` first, greedily matching the `"let"` prefix of `letter`.

**Fix**: `let_decl` rule now starts with `!identifier` negative lookahead, which rejects the match when `let` is part of a longer identifier like `letter`.

---

### B-07 — `typeof(fn() {})` returns `"Unknown"` instead of `"Function"`

| Field | Value |
|-------|-------|
| **Severity** | LOW |
| **Crate** | `vm` |
| **File** | `vm/src/stdlib/core.rs:114-155` |
| **Reproducer** | `let f = fn() {}; print(typeof(f))` |
| **Status** | **FIXED** |

**Root cause**: `typeof` dispatch didn't match closure/function tags.

**Fix**: Added `is_function() || is_closure()` check returning `"Function"`.

---

## Additional Notes

- All 7 bugs were discovered during creation of the `test/` integration test suite
- All 7 bugs have been fixed — test workarounds are no longer necessary
- `print` is grammar-level keyword (not a first-class value) — `typeof(print)` is a parse error, not a bug
- `{}` parses as empty map literal (not empty block) due to PEG ordered choice — by design
